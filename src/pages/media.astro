---
/**
 * Media page — gallery, videos, and press coverage from Ghostbusters Virginia.
 * PRD 008: Media & Gallery Page Redesign
 */
import BaseLayout from "../layouts/BaseLayout.astro";
import Lightbox from "../components/ui/Lightbox.astro";
import { getCollection } from "astro:content";
import { getResponsiveImageAttrs } from "../lib/images";

const galleryItems = await getCollection("gallery");

// Sort by date descending (newest first); undated items go last
const sorted = galleryItems.sort((a, b) => {
  if (a.data.date && b.data.date) return b.data.date.getTime() - a.data.date.getTime();
  if (a.data.date) return -1;
  if (b.data.date) return 1;
  return 0;
});

const galleryImageAttrs = await Promise.all(
  sorted.map((item) =>
    getResponsiveImageAttrs({
      src: item.data.image,
      widths: [480, 768, 1200],
      sizes: "(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw",
      width: 1200,
      height: 750,
      quality: 72,
    }),
  ),
);

const videos = [
  {
    id: "nkb_sAiDSRU",
    title: "Ghostbusters, Virginia Trailer 2020 HD",
  },
  {
    id: "NrVYVayRA7s",
    title: "I Am Ghostbusters Spot (2021)",
  },
  {
    id: "YcRhksZDeQw",
    title: "PlasmaCon 2021 Opening Ceremonies",
  },
];

const newsLinks = [
  {
    title: "Ghostbusters, Virginia teams up with Dominos for Toys for Tots",
    date: "November 27, 2024",
    location: "Woodbridge, Va.",
    url: "https://www.facebook.com/share/p/1Ashb35y1u/",
    source: "Facebook",
    image: "/images/news/in-the-news-3.jpg",
    excerpt:
      "Ghostbusters, Virginia has teamed up with Domino's pizza stores across Woodbridge to help gather toys for the annual Toys for Tots donation drive. Domino's has kindly offered to customers who bring in a toy to donate a one-topping large pizza for $6.",
  },
  {
    title: "Ecto-1 will be on-hand for opening night premiere of 'Ghostbusters: Afterlife'",
    date: "November 19, 2021",
    location: "Chesapeake, Va.",
    url: "https://www.13newsnow.com/article/news/community/ghostbusters-virginia-premiere-afterlife-charity-cinema-cafe/291-ca4322bf-dae9-4321-9408-43e5c2887077",
    source: "13 News Now",
    image: "/images/news/in-the-news-1.png",
    excerpt:
      'Thirty-seven years after the original movie, "Ghostbusters: Afterlife" is set for opening night on Friday. Over in Chesapeake, there is one man ready to arrive in style. "Saw original movie in the theatre back in \'84," said Jeremy West. West is a member of Ghostbusters, Virginia.',
  },
  {
    title: "Who You Gonna Call? Ghostbusters, Virginia!",
    date: "September 28, 2021",
    location: "Portsmouth, Va.",
    url: "https://www.wavy.com/hr-show/cc-who-you-gonna-call-ghostbusters-virginia/",
    source: "WAVY TV 10",
    image: "/images/news/in-the-news-2.png",
    excerpt:
      "Looking to raise money or awareness for your organization in Hampton Roads? You better call the Ghostbusters for this one! You may have seen their Ecto-1 on the streets of Hampton Roads with 20 years of experience in ghostbusting.",
  },
];

const newsImageAttrs = await Promise.all(
  newsLinks.map((link) =>
    getResponsiveImageAttrs({
      src: link.image,
      widths: [480, 768, 960],
      sizes: "(max-width: 768px) 100vw, 280px",
      width: 960,
      height: 540,
      quality: 72,
    }),
  ),
);
---

<BaseLayout
  title="Media"
  description="Browse Ghostbusters Virginia photos, videos, and press coverage from events across the state."
  canonical="/media"
  ogTitle="Media | Ghostbusters Virginia"
  ogDescription="Explore the latest gallery photos, videos, and news features for Ghostbusters Virginia."
  ogImage="/images/gbv-gallery-16.jpg"
>
  <section class="container page" aria-labelledby="media-title">
    <h1 id="media-title" class="page-title">Media</h1>
    <p class="page-intro">
      Photos, videos, and press coverage from our events. Click any photo to enlarge.
    </p>

    <!-- ── Videos ── -->
    <div class="media-section fade-in-section">
      <h2 class="section-heading">Videos</h2>
      <div class="video-grid">
        {
          videos.map((video) => (
            <button
              class="video-card"
              type="button"
              aria-label={`Play video: ${video.title}`}
              data-video-id={video.id}
              data-video-title={video.title}
            >
              <div class="video-card__thumb">
                <img
                  src={`https://img.youtube.com/vi/${video.id}/hqdefault.jpg`}
                  srcset={`https://img.youtube.com/vi/${video.id}/mqdefault.jpg 320w, https://img.youtube.com/vi/${video.id}/hqdefault.jpg 480w, https://img.youtube.com/vi/${video.id}/maxresdefault.jpg 1280w`}
                  sizes="(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 33vw"
                  alt={`Thumbnail for ${video.title}`}
                  loading="lazy"
                  decoding="async"
                  width="480"
                  height="360"
                  class="video-card__image"
                />
                <div class="video-card__play" aria-hidden="true">
                  <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                    <circle cx="24" cy="24" r="24" fill="rgba(0,0,0,0.6)" />
                    <polygon points="19,14 19,34 36,24" fill="white" />
                  </svg>
                </div>
              </div>
              <p class="video-card__title">{video.title}</p>
            </button>
          ))
        }
      </div>
    </div>

    <!-- ── Gallery ── -->
    <div class="media-section fade-in-section">
      <h2 class="section-heading">Gallery</h2>
      {
        sorted.length > 0 ? (
          <>
            <ul class="gallery-grid" role="list" id="gallery-grid">
              {sorted.map((item, index) => (
                <li class:list={[{ "gallery-hidden": index >= 6 }]}>
                  <button
                    class="gallery-card"
                    type="button"
                    aria-label={`View full image: ${item.data.title}`}
                    data-image={item.data.image}
                    data-alt={item.data.alt}
                    data-title={item.data.title}
                  >
                    <div class="gallery-card__image-wrapper">
                      <img
                        src={galleryImageAttrs[index].src}
                        srcset={galleryImageAttrs[index].srcset}
                        sizes={galleryImageAttrs[index].sizes}
                        alt={item.data.alt}
                        loading="lazy"
                        decoding="async"
                        width={galleryImageAttrs[index].width}
                        height={galleryImageAttrs[index].height}
                        class="gallery-card__image"
                      />
                    </div>
                    <div class="gallery-card__info">
                      <span class="gallery-card__title">{item.data.title}</span>
                      {item.data.date && (
                        <time
                          class="gallery-card__date"
                          datetime={item.data.date.toISOString().split("T")[0]}
                        >
                          {item.data.date.toLocaleDateString("en-US", {
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                          })}
                        </time>
                      )}
                    </div>
                  </button>
                </li>
              ))}
            </ul>
            {sorted.length > 6 && (
              <div class="gallery-toggle">
                <button class="toggle-btn" type="button" id="gallery-show-more">
                  Show More ({sorted.length - 6} more)
                </button>
                <button class="toggle-btn" type="button" id="gallery-show-less" hidden>
                  Show Less
                </button>
              </div>
            )}
          </>
        ) : (
          <p class="empty-state">No media yet — check back after our next event!</p>
        )
      }
    </div>

    <!-- ── In the News ── -->
    <div class="media-section fade-in-section">
      <h2 class="section-heading">In the News</h2>
      <ul class="news-list" role="list">
        {
          newsLinks.map((link, index) => (
            <li class="news-item">
              <a href={link.url} target="_blank" rel="noopener noreferrer" class="news-link">
                <div class="news-link__image-wrapper">
                  <img
                    src={newsImageAttrs[index].src}
                    srcset={newsImageAttrs[index].srcset}
                    sizes={newsImageAttrs[index].sizes}
                    alt={`${link.title} article thumbnail`}
                    loading="lazy"
                    decoding="async"
                    width={newsImageAttrs[index].width}
                    height={newsImageAttrs[index].height}
                    class="news-link__image"
                  />
                </div>
                <div class="news-link__body">
                  <span class="news-link__title">{link.title}</span>
                  <span class="news-link__meta">
                    <span class="news-link__date">{link.date}</span>
                    <span class="news-link__location">{link.location}</span>
                  </span>
                  <p class="news-link__excerpt">
                    <em class="news-link__source">{link.source}</em> — {link.excerpt}
                  </p>
                </div>
                <svg
                  class="news-link__external"
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-hidden="true"
                >
                  <>
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                    <polyline points="15 3 21 3 21 9" />
                    <line x1="10" y1="14" x2="21" y2="3" />
                  </>
                </svg>
              </a>
            </li>
          ))
        }
      </ul>
    </div>
  </section>

  <!-- ── Lightbox overlay ── -->
  <Lightbox id="lightbox" hasVideo label="Media viewer" />
</BaseLayout>

<script>
  import { setLightboxPreviousFocus } from "../lib/lightbox";

  // Lightbox functionality — shared component handles close/escape/focus-trap
  const lightbox = document.getElementById("lightbox") as HTMLElement;
  const lightboxImage = document.getElementById("lightbox-image") as HTMLImageElement;
  const lightboxVideo = document.getElementById("lightbox-video") as HTMLElement;
  const lightboxIframe = document.getElementById("lightbox-iframe") as HTMLIFrameElement;
  const lightboxCaption = document.getElementById("lightbox-caption") as HTMLParagraphElement;

  function openImageLightbox(image: string, alt: string, title: string, opener?: HTMLElement) {
    if (!lightbox || !lightboxImage || !lightboxCaption) return;
    if (opener) {
      setLightboxPreviousFocus(lightbox, opener, "media-opener");
    }
    lightboxImage.src = image;
    lightboxImage.alt = alt;
    lightboxImage.hidden = false;
    lightboxVideo!.hidden = true;
    lightboxCaption.textContent = title;
    lightbox.hidden = false;
    document.body.style.overflow = "hidden";
    (lightbox.querySelector(".lightbox__close") as HTMLElement)?.focus();
  }

  function openVideoLightbox(videoId: string, title: string, opener?: HTMLElement) {
    if (!lightbox || !lightboxIframe || !lightboxCaption) return;
    if (opener) {
      setLightboxPreviousFocus(lightbox, opener, "media-opener");
    }
    lightboxIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
    lightboxIframe.title = title;
    lightboxImage!.hidden = true;
    lightboxVideo!.hidden = false;
    lightboxCaption.textContent = title;
    lightbox.hidden = false;
    document.body.style.overflow = "hidden";
    (lightbox.querySelector(".lightbox__close") as HTMLElement)?.focus();
  }

  // Gallery card clicks
  document.querySelectorAll<HTMLButtonElement>(".gallery-card").forEach((card) => {
    card.addEventListener("click", () => {
      const image = card.dataset.image ?? "";
      const alt = card.dataset.alt ?? "";
      const title = card.dataset.title ?? "";
      openImageLightbox(image, alt, title, card);
    });
  });

  // Video card clicks
  document.querySelectorAll<HTMLButtonElement>(".video-card").forEach((card) => {
    card.addEventListener("click", () => {
      const videoId = card.dataset.videoId ?? "";
      const title = card.dataset.videoTitle ?? "";
      openVideoLightbox(videoId, title, card);
    });
  });

  // Gallery show more / show less
  const showMoreBtn = document.getElementById("gallery-show-more") as HTMLButtonElement | null;
  const showLessBtn = document.getElementById("gallery-show-less") as HTMLButtonElement | null;
  const hiddenItems = document.querySelectorAll<HTMLElement>("#gallery-grid .gallery-hidden");

  showMoreBtn?.addEventListener("click", () => {
    hiddenItems.forEach((item) => item.classList.remove("gallery-hidden"));
    showMoreBtn.hidden = true;
    showLessBtn!.hidden = false;
  });

  showLessBtn?.addEventListener("click", () => {
    hiddenItems.forEach((item) => item.classList.add("gallery-hidden"));
    showLessBtn.hidden = true;
    showMoreBtn!.hidden = false;
    document.getElementById("gallery-grid")?.scrollIntoView({ behavior: "smooth", block: "start" });
  });
</script>

<style>
  /* ── Section layout ── */
  .media-section {
    width: 100%;
  }

  /* ── Video grid ── */
  .video-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-xl);
  }

  @media (max-width: 1024px) {
    .video-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .video-grid {
      grid-template-columns: 1fr;
    }
  }

  .video-card {
    display: block;
    width: 100%;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
    box-shadow: var(--shadow-panel);
    cursor: pointer;
    padding: 0;
    font: inherit;
    text-align: left;
    color: inherit;
    transition:
      border-color var(--transition-base),
      box-shadow var(--transition-base),
      transform var(--transition-fast);
  }

  .video-card:hover,
  .video-card:focus-visible {
    border-color: var(--color-hover-border);
    box-shadow: var(--shadow-hover), var(--shadow-panel);
    transform: translateY(-2px);
  }

  .video-card__thumb {
    position: relative;
    overflow: hidden;
  }

  .video-card__image {
    width: 100%;
    aspect-ratio: 16 / 9;
    object-fit: cover;
    display: block;
  }

  .video-card__play {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity var(--transition-fast);
  }

  .video-card:hover .video-card__play {
    opacity: 0.8;
  }

  .video-card__title {
    padding: var(--space-md) var(--space-lg);
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    color: var(--color-text);
    letter-spacing: var(--tracking-wide);
  }

  /* ── Gallery grid ── */
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-xl);
    width: 100%;
    list-style: none;
    padding: 0;
  }

  @media (max-width: 768px) {
    .gallery-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 480px) {
    .gallery-grid {
      grid-template-columns: 1fr;
    }
  }

  /* ── Gallery card (button) ── */
  .gallery-card {
    display: block;
    width: 100%;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-panel);
    overflow: hidden;
    cursor: pointer;
    padding: 0;
    font: inherit;
    text-align: left;
    color: inherit;
    transition:
      border-color var(--transition-base),
      box-shadow var(--transition-base),
      transform var(--transition-fast);
  }

  .gallery-card:hover,
  .gallery-card:focus-visible {
    border-color: var(--color-hover-border);
    box-shadow: var(--shadow-hover), var(--shadow-panel);
    transform: translateY(-2px);
  }

  .gallery-card__image-wrapper {
    overflow: hidden;
  }

  .gallery-card__image {
    width: 100%;
    aspect-ratio: 4 / 3;
    object-fit: cover;
    display: block;
  }

  .gallery-card__info {
    padding: var(--space-md) var(--space-lg);
  }

  .gallery-card__title {
    display: block;
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    color: var(--color-text);
    letter-spacing: var(--tracking-wide);
  }

  .gallery-card__date {
    display: block;
    margin-top: var(--space-xs);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  /* ── News list ── */
  .news-list {
    list-style: none;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  .news-item {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
    position: relative;
    transition:
      border-color var(--transition-base),
      box-shadow var(--transition-base);
  }

  .news-item:hover {
    border-color: var(--color-hover-border);
    box-shadow: var(--shadow-hover);
  }

  .news-link {
    display: flex;
    gap: var(--space-xl);
    padding: var(--space-xl);
    text-decoration: none;
    color: inherit;
  }

  .news-link__image-wrapper {
    flex-shrink: 0;
    width: 200px;
    overflow: hidden;
    border-radius: var(--radius-sm);
  }

  .news-link__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .news-link__body {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    flex: 1;
  }

  .news-link__title {
    font-size: var(--text-lg);
    font-weight: var(--weight-semibold);
    color: var(--color-text);
    line-height: var(--leading-tight);
    transition: color var(--transition-fast);
  }

  .news-link:hover .news-link__title {
    color: var(--color-accent-atmospheric);
  }

  .news-link__date {
    font-family: var(--font-body);
    font-size: var(--text-sm);
    color: var(--color-text);
    letter-spacing: var(--tracking-wide);
  }

  .news-link__meta {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    flex-wrap: wrap;
  }

  .news-link__location {
    font-family: var(--font-body);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    letter-spacing: var(--tracking-wide);
  }

  .news-link__location::before {
    content: "\00B7";
    color: var(--color-accent);
    font-weight: var(--weight-bold);
    margin-right: var(--space-md);
  }

  .news-link__excerpt {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    line-height: var(--leading-normal);
    transition: color var(--transition-fast);
  }

  .news-link:hover .news-link__excerpt {
    color: var(--color-text);
  }

  .news-link__source {
    font-style: italic;
    color: var(--color-text);
    font-weight: var(--weight-semibold);
  }

  .news-link__external {
    position: absolute;
    top: var(--space-lg);
    right: var(--space-lg);
    color: var(--color-text-muted);
    opacity: 0;
    transition: opacity var(--transition-fast);
    flex-shrink: 0;
  }

  .news-item:hover .news-link__external {
    opacity: 1;
  }

  @media (max-width: 768px) {
    .news-link {
      flex-direction: column;
      gap: var(--space-lg);
    }

    .news-link__image-wrapper {
      width: 100%;
      max-height: 200px;
    }
  }

  /* ── Gallery toggle buttons ── */
  .gallery-hidden {
    display: none;
  }

  .gallery-toggle {
    display: flex;
    justify-content: center;
    margin-top: var(--space-xl);
  }
</style>
