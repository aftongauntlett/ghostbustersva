---
/**
 * Home page — hero, gallery, upcoming events, join CTA, swag.
 */
import BaseLayout from "../layouts/BaseLayout.astro";
import Button from "../components/ui/Button.astro";
import EventCard from "../components/EventCard.astro";
import HeroSection from "../components/HeroSection";
import Lightbox from "../components/ui/Lightbox.astro";
import { getCollection } from "astro:content";
import { splitEventsByStatus } from "../lib/events";
import { swagItems } from "../lib/swag";
import { getResponsiveImageAttrs } from "../lib/images";

const allEvents = await getCollection("events");
// Date-derived partitions reflect the current build snapshot.
const { upcoming } = splitEventsByStatus(allEvents);

const galleryItems = await getCollection("gallery");
const heroImage = await getResponsiveImageAttrs({
  src: "/images/gbv-gallery-09.jpg",
  widths: [768, 1200, 1600],
  sizes: "100vw",
  width: 1600,
  height: 900,
  quality: 80,
});
const joinImage = await getResponsiveImageAttrs({
  src: "/images/gbv-gallery-05.jpg",
  widths: [640, 960, 1200],
  sizes: "(max-width: 768px) 100vw, 50vw",
  width: 1200,
  height: 900,
  quality: 75,
});
const galleryImageAttrs = await Promise.all(
  galleryItems.map((item) =>
    getResponsiveImageAttrs({
      src: item.data.image,
      widths: [480, 768, 1200],
      sizes: "(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw",
      width: 1200,
      height: 750,
      quality: 72,
    }),
  ),
);
const swagImageAttrs = await Promise.all(
  swagItems.map((item) =>
    getResponsiveImageAttrs({
      src: item.image,
      widths: [320, 480, 640],
      sizes: "(max-width: 768px) 50vw, 20vw",
      width: 640,
      height: 640,
      quality: 72,
    }),
  ),
);
---

<BaseLayout
  title="Home"
  description="Ghostbusters Virginia is a Sony-recognized 501(c)(3) nonprofit bringing fandom and community service together across Virginia."
  canonical="/"
  ogTitle="Ghostbusters Virginia"
  ogDescription="See upcoming events, media, and ways to join or support Ghostbusters Virginia."
  ogImage="/images/gbv-gallery-09.jpg"
  showGhostParticles
  heroImagePreload={heroImage}
>
  <!-- ───── HERO (React island — PRD 009 Tier 2) ───── -->
  <HeroSection client:load heroImage={heroImage} />
  <!-- Inline script: reveal hero only after the background image has loaded.
       Runs immediately when parsed — no React hydration dependency. -->
  <script is:inline>
    (function () {
      var container = document.querySelector('.hero-container');
      var img = container && container.querySelector('.hero-bg-img');
      if (!container) return;
      function reveal() { container.classList.add('hero-ready'); }
      if (img && img.complete && img.naturalWidth > 0) {
        reveal();
      } else if (img) {
        img.addEventListener('load', reveal, { once: true });
        img.addEventListener('error', reveal, { once: true });
        setTimeout(reveal, 1500);
      } else {
        setTimeout(reveal, 800);
      }
    })();
  </script>

  <!-- ───── MISSION / IDENTITY ───── -->
  <section
    class="container section mission-section fade-in-section"
    aria-labelledby="mission-heading"
  >
    <h2 id="mission-heading" class="section-heading">Officially Recognized. Community Driven.</h2>
    <p class="section-subtitle">
      Since 2001, Virginia’s only Sony-recognized Ghostbusters nonprofit has been turning fandom
      into community impact.
    </p>

    <div class="mission-grid">
      <div class="mission-text">
        <p class="mission-body">
          Ghostbusters Virginia is the only <strong class="glow">501c3 nonprofit</strong> recognized by
          <strong class="glow">Sony&rsquo;s Ghost Corps</strong> in the state. Since <strong
            class="glow">2001</strong
          >, we&rsquo;ve united fans across the Commonwealth to turn our love of Ghostbusters into <strong
            class="glow">real community impact</strong
          >.
        </p>
        <p class="mission-body">
          We participate in <strong class="glow">community events all over Virginia</strong> to help raise
          money and awareness for other charities, and spread the love of Ghostbusters all over the Commonwealth
          in a <strong class="glow">safe, fun, and family friendly</strong> manner.
        </p>
      </div>
      <div class="mission-card">
        <ul class="mission-list glow-list" role="list">
          <li>Raise money for local and national charities</li>
          <li>Visit children&rsquo;s hospitals in full Ghostbusters gear</li>
          <li>Appear at parades, comic cons, and community festivals</li>
          <li>Welcome fans of all ages and backgrounds across Virginia</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- ───── GALLERY ───── -->
  {
    galleryItems.length > 0 && (
      <section class="container section fade-in-section" aria-labelledby="gallery-heading">
        <h2 id="gallery-heading" class="section-heading">
          Out in the Field
        </h2>
        <p class="section-subtitle">
          From charity fundraisers and hospital visits to comic conventions and community parades.
        </p>
        <div id="gallery-splide" class="splide" aria-label="Photo gallery carousel">
          <div class="splide__track">
            <ul class="splide__list">
              {galleryItems.map((item, index) => (
                <li class="splide__slide">
                  <button
                    class="gallery-slide"
                    type="button"
                    aria-label={`View full image: ${item.data.title}`}
                    data-image={item.data.image}
                    data-alt={item.data.alt}
                    data-title={item.data.title}
                  >
                    <img
                      src={galleryImageAttrs[index].src}
                      srcset={galleryImageAttrs[index].srcset}
                      sizes={galleryImageAttrs[index].sizes}
                      alt={item.data.alt}
                      loading="lazy"
                      decoding="async"
                      width={galleryImageAttrs[index].width}
                      height={galleryImageAttrs[index].height}
                      class="gallery-slide__img"
                    />
                    <span class="gallery-slide__title">{item.data.title}</span>
                  </button>
                </li>
              ))}
            </ul>
          </div>
        </div>
        <div class="gallery-cta">
          <Button variant="primary" href="/media">
            See All Media
          </Button>
        </div>
      </section>
    )
  }

  <!-- ───── UPCOMING EVENTS ───── -->
  {
    upcoming.length > 0 && (
      <section class="container section fade-in-section" aria-labelledby="upcoming-heading">
        <h2 id="upcoming-heading" class="section-heading">
          Upcoming Events
        </h2>
        <p class="section-subtitle">
          Meet the team, support local charities, and see the Ecto in person. Check out where
          we&rsquo;ll be next &mdash; we&rsquo;d love to see you there.
        </p>
        <ul class="event-list">
          {upcoming.map((event) => (
            <EventCard event={event} status="upcoming" showCountdown />
          ))}
        </ul>
        <div class="section-cta">
          <Button variant="primary" href="/events">
            See Past Events
          </Button>
        </div>
      </section>
    )
  }

  <!-- ───── JOIN US ───── -->
  <section class="container section join-section fade-in-section" aria-labelledby="join-heading">
    <h2 id="join-heading" class="section-heading">Join the Team</h2>
    <p class="section-subtitle">
      Whether you&rsquo;re a lifelong Ghosthead or just getting started, there&rsquo;s a place for
      you in our franchise. Join a community of fans who build props, attend events, visit
      hospitals, and raise money for charity &mdash; all while having a blast.
    </p>
    <div class="join-layout">
      <div class="join-image-wrapper">
        <img
          src={joinImage.src}
          srcset={joinImage.srcset}
          sizes={joinImage.sizes}
          alt="Three Ghostbusters Virginia members in full uniforms posing at a movie premiere event"
          class="join-image"
          loading="lazy"
          decoding="async"
          width={joinImage.width}
          height={joinImage.height}
        />
      </div>
      <blockquote class="quote-block">
        <p>
          &ldquo;Do you believe in UFOs, astral projections, mental telepathy, ESP, clairvoyance,
          spirit photography, telekinetic movement, full trance mediums, the Loch Ness monster and
          the theory of Atlantis?&rdquo;
        </p>
        <p>
          Ready to get out there and start busting some ghosts? Excellent news rookie, we have
          openings!
        </p>
      </blockquote>
    </div>
    <div class="section-cta">
      <Button variant="primary" href="/join">Join Now</Button>
    </div>
  </section>

  <!-- ───── GBVA SWAG ───── -->
  <section class="container section swag-section fade-in-section" aria-labelledby="swag-heading">
    <h2 id="swag-heading" class="section-heading">Support the Mission</h2>
    <p class="section-subtitle">
      Every purchase helps fund our charity work, community events, and hospital visits across
      Virginia. Grab some gear and wear your support &mdash; we&rsquo;re ready to believe you!
    </p>
    <div class="swag-grid">
      {
        swagItems.map((item, index) => (
          <a href={item.url} target="_blank" rel="noopener noreferrer" class="swag-item">
            <img
              src={swagImageAttrs[index].src}
              srcset={swagImageAttrs[index].srcset}
              sizes={swagImageAttrs[index].sizes}
              alt={item.alt}
              loading="lazy"
              decoding="async"
              width={swagImageAttrs[index].width}
              height={swagImageAttrs[index].height}
              class="swag-thumb"
            />
            <span class="sr-only"> (opens in new tab)</span>
          </a>
        ))
      }
    </div>
    <div class="section-cta">
      <Button variant="primary" href="https://www.teepublic.com/user/ghostbustersva" external>
        Visit Our Store
      </Button>
    </div>
  </section>

  <!-- ── Lightbox overlay ── -->
  <Lightbox id="home-lightbox" hasNav label="Image viewer" />
</BaseLayout>

<style>
  /* ── Homepage section spacing ── */
  .section {
    padding-block: var(--space-3xl);
  }

  /* Override global left-align for homepage centered layout */
  .section-heading {
    text-align: center;
  }

  /* ── Mission / Identity section ── */
  .mission-section {
    text-align: center;
    padding-top: var(--space-3xl);
  }

  .mission-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-xl);
    margin-bottom: var(--space-lg);
    text-align: left;
  }

  @media (min-width: 768px) {
    .mission-grid {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2xl);
      align-items: stretch;
    }
  }

  .mission-text {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .mission-body {
    font-size: var(--text-lg);
    line-height: var(--leading-loose);
    color: var(--color-text-muted);
    margin: 0;
  }

  /* ── Mission card ── */
  .mission-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-left: 3px solid rgba(0, 230, 118, 0.45);
    border-radius: var(--radius-md);
    padding: var(--space-xl) var(--space-2xl);
    text-align: left;
    display: flex;
    align-items: center;
    transition:
      border-color var(--transition-base),
      box-shadow var(--transition-base);
  }

  .mission-card:hover {
    border-color: rgba(0, 230, 118, 0.35);
    box-shadow:
      0 0 10px rgba(0, 230, 118, 0.2),
      0 0 20px rgba(0, 230, 118, 0.08);
  }

  .mission-card:hover .glow-list li {
    color: var(--color-text);
  }

  .mission-card:hover .glow-list li::before {
    background: rgba(0, 230, 118, 0.9);
    box-shadow:
      0 0 6px rgba(0, 230, 118, 0.7),
      0 0 14px rgba(0, 230, 118, 0.35);
  }

  .mission-list {
    margin: 0;
    columns: 1 !important;
    display: flex !important;
    flex-direction: column;
  }

  .gallery-cta {
    margin-top: var(--space-3xl);
    display: flex;
    justify-content: center;
  }

  /* ── Upcoming events ── */
  .event-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  /* ── Join section ── */
  .join-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-2xl);
    align-items: stretch;
  }

  @media (min-width: 768px) {
    .join-layout {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2xl);
    }
  }

  .join-image-wrapper {
    border-radius: var(--radius-md);
    overflow: hidden;
    border: 1px solid var(--color-border);
    transition:
      border-color var(--transition-base),
      box-shadow var(--transition-base);
  }

  .join-image-wrapper:hover {
    border-color: rgba(0, 230, 118, 0.35);
    box-shadow:
      0 0 10px rgba(0, 230, 118, 0.2),
      0 0 20px rgba(0, 230, 118, 0.08);
  }

  .join-image {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
    filter: brightness(0.85) saturate(0.9);
  }
</style>

<!-- Splide carousel + lightbox -->
<script>
  import Splide from "@splidejs/splide";
  import "@splidejs/splide/css";
  import { setLightboxPreviousFocus } from "../lib/lightbox";

  document.addEventListener("DOMContentLoaded", () => {
    const el = document.getElementById("gallery-splide");
    if (!el) return;

    const splide = new Splide(el, {
      type: "loop",
      perPage: 3,
      gap: "1rem",
      autoplay: true,
      interval: 7000,
      pauseOnHover: true,
      pauseOnFocus: true,
      pagination: true,
      arrows: true,
      breakpoints: {
        1024: { perPage: 2 },
        640: { perPage: 1 },
      },
    }).mount();

    // ── Lightbox (shared component handles close/escape/focus-trap) ──
    const lightbox = document.getElementById("home-lightbox") as HTMLElement;
    const lightboxImage = document.getElementById("home-lightbox-image") as HTMLImageElement;
    const lightboxCaption = document.getElementById(
      "home-lightbox-caption",
    ) as HTMLParagraphElement;
    const prevBtn = lightbox?.querySelector(".lightbox__nav--prev") as HTMLButtonElement;
    const nextBtn = lightbox?.querySelector(".lightbox__nav--next") as HTMLButtonElement;

    // Build ordered list of gallery images from the slides
    const slides = Array.from(
      document.querySelectorAll<HTMLButtonElement>("#gallery-splide .gallery-slide"),
    );
    const images = slides.map((s) => ({
      image: s.dataset.image ?? "",
      alt: s.dataset.alt ?? "",
      title: s.dataset.title ?? "",
    }));
    let currentIndex = 0;

    function showImage(index: number) {
      currentIndex = ((index % images.length) + images.length) % images.length;
      const item = images[currentIndex];
      lightboxImage.src = item.image;
      lightboxImage.alt = item.alt;
      lightboxCaption.textContent = item.title;
    }

    function openLightbox(index: number, opener?: HTMLElement) {
      if (!lightbox || !lightboxImage || !lightboxCaption) return;
      if (opener) {
        setLightboxPreviousFocus(lightbox, opener, `home-gallery-trigger-${index}`);
      }
      showImage(index);
      lightbox.hidden = false;
      document.body.style.overflow = "hidden";
      splide.Components.Autoplay?.pause();
      (lightbox.querySelector(".lightbox__close") as HTMLElement)?.focus();
    }

    // Resume autoplay when lightbox closes (shared component dispatches this)
    lightbox?.addEventListener("lightbox:close", () => {
      splide.Components.Autoplay?.play();
    });

    // Gallery slide clicks
    slides.forEach((slide, i) => {
      slide.addEventListener("click", () => openLightbox(i, slide));
    });

    // Prev/next nav + arrow keys
    prevBtn?.addEventListener("click", () => showImage(currentIndex - 1));
    nextBtn?.addEventListener("click", () => showImage(currentIndex + 1));

    document.addEventListener("keydown", (e) => {
      if (!lightbox || lightbox.hidden) return;
      if (e.key === "ArrowLeft") showImage(currentIndex - 1);
      if (e.key === "ArrowRight") showImage(currentIndex + 1);
    });
  });
</script>

<style is:global>
  /* ── Splide theme overrides for Ghostbusters dark theme ── */

  /* Arrow buttons */
  #gallery-splide .splide__arrow {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    opacity: 0.85;
    width: 2.5rem;
    height: 2.5rem;
    transition:
      background var(--transition-base),
      border-color var(--transition-base),
      box-shadow var(--transition-base);
  }
  #gallery-splide .splide__arrow:hover {
    background: var(--color-surface-alt);
    border-color: var(--color-accent);
    box-shadow: var(--shadow-glow);
    opacity: 1;
  }
  #gallery-splide .splide__arrow svg {
    fill: var(--color-text);
    width: 1rem;
    height: 1rem;
  }
  #gallery-splide .splide__arrow:hover svg {
    fill: var(--color-accent-hover);
  }

  /* Pagination dots */
  #gallery-splide .splide__pagination {
    bottom: -1.75rem;
  }
  #gallery-splide .splide__pagination__page {
    background: var(--color-border);
    opacity: 0.6;
    width: 8px;
    height: 8px;
    transition:
      background var(--transition-base),
      transform var(--transition-base),
      box-shadow var(--transition-base);
  }
  #gallery-splide .splide__pagination__page.is-active {
    background: #00e676;
    transform: scale(1.3);
    box-shadow:
      0 0 8px rgba(0, 230, 118, 0.6),
      0 0 16px rgba(0, 230, 118, 0.25);
    opacity: 1;
  }
  #gallery-splide .splide__pagination__page:hover {
    background: rgba(0, 230, 118, 0.7);
    opacity: 1;
  }

  /* Slide content */
  .gallery-slide {
    position: relative;
    border-radius: var(--radius-md);
    overflow: hidden;
    border: 1px solid var(--color-border);
    cursor: pointer;
    padding: 0;
    background: none;
    font: inherit;
    color: inherit;
    text-align: left;
    width: 100%;
    display: block;
    transition:
      border-color var(--transition-base),
      box-shadow var(--transition-base);
  }
  .gallery-slide:hover {
    border-color: rgba(0, 230, 118, 0.35);
    box-shadow:
      0 0 10px rgba(0, 230, 118, 0.2),
      0 0 20px rgba(0, 230, 118, 0.08);
  }
  .gallery-slide__img {
    width: 100%;
    aspect-ratio: 16 / 10;
    object-fit: cover;
    display: block;
    filter: brightness(0.82) saturate(0.9);
  }
  .gallery-slide__title {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 2.5rem 0.75rem 0.6rem;
    font-size: var(--text-sm);
    color: #fff;
    background: linear-gradient(transparent 0%, rgba(0, 0, 0, 0.45) 40%, rgba(0, 0, 0, 0.9) 100%);
    pointer-events: none;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
  }

  /* Spacing for pagination below */
  #gallery-splide {
    padding-bottom: var(--space-2xl);
  }
</style>
