---
/**
 * Home page — hero, gallery, upcoming events, join CTA, swag.
 */
import BaseLayout from "../layouts/BaseLayout.astro";
import Button from "../components/ui/Button.astro";
import StatusPill from "../components/ui/StatusPill.astro";
import EventCountdown from "../components/EventCountdown.astro";
import HeroSection from "../components/HeroSection";
import Lightbox from "../components/ui/Lightbox.astro";
import { getCollection } from "astro:content";

const allEvents = await getCollection("events");
const upcoming = allEvents
  .filter((e) => !e.data.past)
  .sort((a, b) => a.data.date.getTime() - b.data.date.getTime());

/** Format a single date or date range (UTC-safe to avoid off-by-one). */
function formatEventDate(start: Date, end?: Date): string {
  const opts: Intl.DateTimeFormatOptions = { timeZone: "UTC" };
  if (!end) {
    return start.toLocaleDateString("en-US", {
      ...opts,
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  }
  const sMonth = start.toLocaleDateString("en-US", { ...opts, month: "long" });
  const eMonth = end.toLocaleDateString("en-US", { ...opts, month: "long" });
  if (sMonth === eMonth) {
    return `${sMonth} ${start.getUTCDate()}–${end.getUTCDate()}, ${start.getUTCFullYear()}`;
  }
  return `${start.toLocaleDateString("en-US", { ...opts, month: "long", day: "numeric" })} – ${end.toLocaleDateString("en-US", { ...opts, year: "numeric", month: "long", day: "numeric" })}`;
}

const galleryItems = await getCollection("gallery");

const swagItems = [
  {
    image: "/images/swag-thumbnails/gbva-logo.png",
    alt: "GBVA Logo t-shirt",
    url: "https://www.teepublic.com/t-shirt/12021815-gbva-logo?store_id=411517",
  },
  {
    image: "/images/swag-thumbnails/gbva-ii.png",
    alt: "GBVA II t-shirt",
    url: "https://www.teepublic.com/t-shirt/12021859-gbva-ii?store_id=411517",
  },
  {
    image: "/images/swag-thumbnails/plasmacon.png",
    alt: "PlasmaCon 2021 Design t-shirt",
    url: "https://www.teepublic.com/t-shirt/24500969-plasmacon-2021-design?store_id=411517",
  },
  {
    image: "/images/swag-thumbnails/real-ghostbusters-va.png",
    alt: "The Real Ghostbusters Virginia t-shirt",
    url: "https://www.teepublic.com/t-shirt/12701074-the-real-ghostbusters-virginia?store_id=411517",
  },
  {
    image: "/images/swag-thumbnails/gbva-1a.png",
    alt: "GBVA 1A t-shirt",
    url: "https://www.teepublic.com/t-shirt/12021889-gbva-1a?store_id=411517",
  },
  {
    image: "/images/swag-thumbnails/hazard.png",
    alt: "Hazard t-shirt",
    url: "https://www.teepublic.com/t-shirt/12018937-hazard?store_id=411517",
  },
  {
    image: "/images/swag-thumbnails/ii-hazard.png",
    alt: "GBVA II Hazard t-shirt",
    url: "https://www.teepublic.com/t-shirt/12021914-gbva-ii-hazard?store_id=411517",
  },
  {
    image: "/images/swag-thumbnails/junior-pufts-seal.png",
    alt: "GBVA Junior Pufts Seal t-shirt",
    url: "https://www.teepublic.com/t-shirt/12473477-gbva-junior-pufts-seal?store_id=411517",
  },
  {
    image: "/images/swag-thumbnails/gbva-junior-pufts.png",
    alt: "GBVA Junior Pufts t-shirt",
    url: "https://www.teepublic.com/t-shirt/12473218-gbva-junior-pufts?store_id=411517",
  },
  {
    image: "/images/swag-thumbnails/virginia-is-for-busters.png",
    alt: "Virginia Is For Busters t-shirt",
    url: "https://www.teepublic.com/t-shirt/12172631-virginia-is-for-busters?store_id=411517",
  },
];
---

<BaseLayout title="Home">
  <!-- ───── HERO (React island — PRD 009 Tier 2) ───── -->
  <HeroSection client:load />

  <!-- ───── MISSION / IDENTITY ───── -->
  <section
    class="container section mission-section fade-in-section"
    aria-labelledby="mission-heading"
  >
    <h2 id="mission-heading" class="section-heading">Officially Recognized. Community Driven.</h2>
    <p class="section-subtitle">
      Since 2001, Virginia’s only Sony-recognized Ghostbusters nonprofit has been turning fandom
      into community impact.
    </p>

    <div class="mission-grid">
      <div class="mission-text">
        <p class="mission-body">
          Ghostbusters Virginia is the only <strong class="glow">501c3 nonprofit</strong> recognized by
          <strong class="glow">Sony&rsquo;s Ghost Corps</strong> in the state. Since <strong
            class="glow">2001</strong
          >, we&rsquo;ve united fans across the Commonwealth to turn our love of Ghostbusters into <strong
            class="glow">real community impact</strong
          >.
        </p>
        <p class="mission-body">
          We participate in <strong class="glow">community events all over Virginia</strong> to help raise
          money and awareness for other charities, and spread the love of Ghostbusters all over the Commonwealth
          in a <strong class="glow">safe, fun, and family friendly</strong> manner.
        </p>
      </div>
      <div class="mission-card">
        <ul class="mission-list glow-list" role="list">
          <li>Raise money for local and national charities</li>
          <li>Visit children&rsquo;s hospitals in full Ghostbusters gear</li>
          <li>Appear at parades, comic cons, and community festivals</li>
          <li>Welcome fans of all ages and backgrounds across Virginia</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- ───── GALLERY ───── -->
  {
    galleryItems.length > 0 && (
      <section class="container section fade-in-section" aria-labelledby="gallery-heading">
        <h2 id="gallery-heading" class="section-heading">
          Out in the Field
        </h2>
        <p class="section-subtitle">
          From charity fundraisers and hospital visits to comic conventions and community parades.
        </p>
        <div id="gallery-splide" class="splide" aria-label="Photo gallery carousel">
          <div class="splide__track">
            <ul class="splide__list">
              {galleryItems.map((item) => (
                <li class="splide__slide">
                  <button
                    class="gallery-slide"
                    type="button"
                    aria-label={`View full image: ${item.data.title}`}
                    data-image={item.data.image}
                    data-alt={item.data.alt}
                    data-title={item.data.title}
                  >
                    <img
                      src={item.data.image}
                      alt={item.data.alt}
                      loading="lazy"
                      class="gallery-slide__img"
                    />
                    <span class="gallery-slide__title">{item.data.title}</span>
                  </button>
                </li>
              ))}
            </ul>
          </div>
        </div>
        <div class="gallery-cta">
          <Button variant="primary" href="/media">
            See All Media
          </Button>
        </div>
      </section>
    )
  }

  <!-- ───── UPCOMING EVENTS ───── -->
  {
    upcoming.length > 0 && (
      <section class="container section fade-in-section" aria-labelledby="upcoming-heading">
        <h2 id="upcoming-heading" class="section-heading">
          Upcoming Events
        </h2>
        <p class="section-subtitle">
          Meet the team, support local charities, and see the Ecto in person. Check out where
          we&rsquo;ll be next &mdash; we&rsquo;d love to see you there.
        </p>
        <ul class="event-list">
          {upcoming.map((event) => (
            <li
              class="event-item"
              data-event-end={
                event.data.endDate
                  ? new Date(event.data.endDate.getTime() + 86400000).toISOString()
                  : undefined
              }
            >
              {event.data.url ? (
                <a
                  href={event.data.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="event-link"
                >
                  {event.data.image && (
                    <div class="event-link__image-wrapper">
                      <img
                        src={event.data.image}
                        alt={`Photo for ${event.data.title}`}
                        loading="lazy"
                        class="event-link__image"
                      />
                    </div>
                  )}
                  <div class="event-link__body">
                    <div class="event-link__header">
                      <span class="event-link__title">{event.data.title}</span>
                      <StatusPill status="active">Upcoming</StatusPill>
                    </div>
                    <span class="event-link__meta">
                      <time
                        class="event-link__date"
                        datetime={event.data.date.toISOString().split("T")[0]}
                      >
                        {formatEventDate(event.data.date, event.data.endDate)}
                      </time>
                      {event.data.location && (
                        <span class="event-link__location">{event.data.location}</span>
                      )}
                    </span>
                    <p class="event-link__summary">{event.data.summary}</p>
                    {event.data.endDate && (
                      <EventCountdown startDate={event.data.date} endDate={event.data.endDate} />
                    )}
                    {event.data.address && (
                      <address class="event-link__address">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="14"
                          height="14"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          aria-hidden="true"
                        >
                          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                          <circle cx="12" cy="10" r="3" />
                        </svg>
                        <span>
                          {event.data.location} &middot; {event.data.address}
                        </span>
                      </address>
                    )}
                  </div>
                  <svg
                    class="event-link__external"
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    aria-hidden="true"
                  >
                    <>
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                      <polyline points="15 3 21 3 21 9" />
                      <line x1="10" y1="14" x2="21" y2="3" />
                    </>
                  </svg>
                </a>
              ) : (
                <div class="event-link">
                  {event.data.image && (
                    <div class="event-link__image-wrapper">
                      <img
                        src={event.data.image}
                        alt={`Photo for ${event.data.title}`}
                        loading="lazy"
                        class="event-link__image"
                      />
                    </div>
                  )}
                  <div class="event-link__body">
                    <div class="event-link__header">
                      <span class="event-link__title">{event.data.title}</span>
                      <StatusPill status="active">Upcoming</StatusPill>
                    </div>
                    <span class="event-link__meta">
                      <time
                        class="event-link__date"
                        datetime={event.data.date.toISOString().split("T")[0]}
                      >
                        {formatEventDate(event.data.date, event.data.endDate)}
                      </time>
                      {event.data.location && (
                        <span class="event-link__location">{event.data.location}</span>
                      )}
                    </span>
                    <p class="event-link__summary">{event.data.summary}</p>
                    {event.data.endDate && (
                      <EventCountdown startDate={event.data.date} endDate={event.data.endDate} />
                    )}
                    {event.data.address && (
                      <address class="event-link__address">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="14"
                          height="14"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          aria-hidden="true"
                        >
                          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                          <circle cx="12" cy="10" r="3" />
                        </svg>
                        <span>
                          {event.data.location} &middot; {event.data.address}
                        </span>
                      </address>
                    )}
                  </div>
                </div>
              )}
            </li>
          ))}
        </ul>
        <div class="section-cta">
          <Button variant="primary" href="/events">
            See Past Events
          </Button>
        </div>
      </section>
    )
  }

  <!-- ───── JOIN US ───── -->
  <section class="container section join-section fade-in-section" aria-labelledby="join-heading">
    <h2 id="join-heading" class="section-heading">Join the Team</h2>
    <p class="section-subtitle">
      Whether you&rsquo;re a lifelong Ghosthead or just getting started, there&rsquo;s a place for
      you in our franchise. Join a community of fans who build props, attend events, visit
      hospitals, and raise money for charity &mdash; all while having a blast.
    </p>
    <div class="join-layout">
      <div class="join-image-wrapper">
        <img
          src="/images/gbv-gallery-05.jpg"
          alt="Three Ghostbusters Virginia members in full uniforms posing at a movie premiere event"
          class="join-image"
          loading="lazy"
        />
      </div>
      <blockquote class="quote-block">
        <p>
          &ldquo;Do you believe in UFOs, astral projections, mental telepathy, ESP, clairvoyance,
          spirit photography, telekinetic movement, full trance mediums, the Loch Ness monster and
          the theory of Atlantis?&rdquo;
        </p>
        <p>
          Ready to get out there and start busting some ghosts? Excellent news rookie, we have
          openings!
        </p>
      </blockquote>
    </div>
    <div class="section-cta">
      <Button variant="primary" href="/join">Join Now</Button>
    </div>
  </section>

  <!-- ───── GBVA SWAG ───── -->
  <section class="container section swag-section fade-in-section" aria-labelledby="swag-heading">
    <h2 id="swag-heading" class="section-heading">Support the Mission</h2>
    <p class="section-subtitle">
      Every purchase helps fund our charity work, community events, and hospital visits across
      Virginia. Grab some gear and wear your support &mdash; we&rsquo;re ready to believe you!
    </p>
    <div class="swag-grid">
      {
        swagItems.map((item) => (
          <a href={item.url} target="_blank" rel="noopener noreferrer" class="swag-item">
            <img src={item.image} alt={item.alt} loading="lazy" class="swag-thumb" />
            <span class="sr-only"> (opens in new tab)</span>
          </a>
        ))
      }
    </div>
    <div class="section-cta">
      <Button variant="primary" href="https://www.teepublic.com/user/ghostbustersva" external>
        Visit Our Store
      </Button>
    </div>
  </section>

  <!-- ── Lightbox overlay ── -->
  <Lightbox id="home-lightbox" hasNav label="Image viewer" />
</BaseLayout>

<style>
  /* ── Homepage section spacing ── */
  .section {
    padding-block: var(--space-3xl);
  }

  /* Override global left-align for homepage centered layout */
  .section-heading {
    text-align: center;
  }

  /* ── Mission / Identity section ── */
  .mission-section {
    text-align: center;
    padding-top: var(--space-3xl);
  }

  .mission-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-xl);
    margin-bottom: var(--space-lg);
    text-align: left;
  }

  @media (min-width: 768px) {
    .mission-grid {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2xl);
      align-items: stretch;
    }
  }

  .mission-text {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .mission-body {
    font-size: var(--text-lg);
    line-height: var(--leading-loose);
    color: var(--color-text-muted);
    margin: 0;
  }

  /* ── Mission card ── */
  .mission-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-left: 3px solid rgba(0, 230, 118, 0.45);
    border-radius: var(--radius-md);
    padding: var(--space-xl) var(--space-2xl);
    text-align: left;
    display: flex;
    align-items: center;
    transition:
      border-color var(--transition-base),
      box-shadow var(--transition-base);
  }

  .mission-card:hover {
    border-color: rgba(0, 230, 118, 0.35);
    box-shadow:
      0 0 10px rgba(0, 230, 118, 0.2),
      0 0 20px rgba(0, 230, 118, 0.08);
  }

  .mission-card:hover .glow-list li {
    color: var(--color-text);
  }

  .mission-card:hover .glow-list li::before {
    background: rgba(0, 230, 118, 0.9);
    box-shadow:
      0 0 6px rgba(0, 230, 118, 0.7),
      0 0 14px rgba(0, 230, 118, 0.35);
  }

  .mission-list {
    margin: 0;
    columns: 1 !important;
    display: flex !important;
    flex-direction: column;
  }

  .gallery-cta {
    margin-top: var(--space-3xl);
    display: flex;
    justify-content: center;
  }

  /* ── Upcoming events ── */
  .event-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  /* ── Join section ── */
  .join-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-2xl);
    align-items: stretch;
  }

  @media (min-width: 768px) {
    .join-layout {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2xl);
    }
  }

  .join-image-wrapper {
    border-radius: var(--radius-md);
    overflow: hidden;
    border: 1px solid var(--color-border);
    transition:
      border-color var(--transition-base),
      box-shadow var(--transition-base);
  }

  .join-image-wrapper:hover {
    border-color: rgba(0, 230, 118, 0.35);
    box-shadow:
      0 0 10px rgba(0, 230, 118, 0.2),
      0 0 20px rgba(0, 230, 118, 0.08);
  }

  .join-image {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
    filter: brightness(0.85) saturate(0.9);
  }
</style>

<!-- Splide carousel + lightbox -->
<script>
  import Splide from "@splidejs/splide";
  import "@splidejs/splide/css";

  document.addEventListener("DOMContentLoaded", () => {
    const el = document.getElementById("gallery-splide");
    if (!el) return;

    const splide = new Splide(el, {
      type: "loop",
      perPage: 3,
      gap: "1rem",
      autoplay: true,
      interval: 7000,
      pauseOnHover: true,
      pauseOnFocus: true,
      pagination: true,
      arrows: true,
      breakpoints: {
        1024: { perPage: 2 },
        640: { perPage: 1 },
      },
    }).mount();

    // ── Lightbox (shared component handles close/escape/focus-trap) ──
    const lightbox = document.getElementById("home-lightbox") as HTMLElement;
    const lightboxImage = document.getElementById("home-lightbox-image") as HTMLImageElement;
    const lightboxCaption = document.getElementById(
      "home-lightbox-caption",
    ) as HTMLParagraphElement;
    const prevBtn = lightbox?.querySelector(".lightbox__nav--prev") as HTMLButtonElement;
    const nextBtn = lightbox?.querySelector(".lightbox__nav--next") as HTMLButtonElement;

    // Build ordered list of gallery images from the slides
    const slides = Array.from(
      document.querySelectorAll<HTMLButtonElement>("#gallery-splide .gallery-slide"),
    );
    const images = slides.map((s) => ({
      image: s.dataset.image ?? "",
      alt: s.dataset.alt ?? "",
      title: s.dataset.title ?? "",
    }));
    let currentIndex = 0;

    function showImage(index: number) {
      currentIndex = ((index % images.length) + images.length) % images.length;
      const item = images[currentIndex];
      lightboxImage.src = item.image;
      lightboxImage.alt = item.alt;
      lightboxCaption.textContent = item.title;
    }

    function openLightbox(index: number) {
      if (!lightbox || !lightboxImage || !lightboxCaption) return;
      showImage(index);
      lightbox.hidden = false;
      document.body.style.overflow = "hidden";
      splide.Components.Autoplay?.pause();
      (lightbox.querySelector(".lightbox__close") as HTMLElement)?.focus();
    }

    // Resume autoplay when lightbox closes (shared component dispatches this)
    lightbox?.addEventListener("lightbox:close", () => {
      splide.Components.Autoplay?.play();
    });

    // Gallery slide clicks
    slides.forEach((slide, i) => {
      slide.addEventListener("click", () => openLightbox(i));
    });

    // Prev/next nav + arrow keys
    prevBtn?.addEventListener("click", () => showImage(currentIndex - 1));
    nextBtn?.addEventListener("click", () => showImage(currentIndex + 1));

    document.addEventListener("keydown", (e) => {
      if (!lightbox || lightbox.hidden) return;
      if (e.key === "ArrowLeft") showImage(currentIndex - 1);
      if (e.key === "ArrowRight") showImage(currentIndex + 1);
    });
  });
</script>

<style is:global>
  /* ── Splide theme overrides for Ghostbusters dark theme ── */

  /* Arrow buttons */
  #gallery-splide .splide__arrow {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    opacity: 0.85;
    width: 2.5rem;
    height: 2.5rem;
    transition:
      background var(--transition-base),
      border-color var(--transition-base),
      box-shadow var(--transition-base);
  }
  #gallery-splide .splide__arrow:hover {
    background: var(--color-surface-alt);
    border-color: var(--color-accent);
    box-shadow: var(--shadow-glow);
    opacity: 1;
  }
  #gallery-splide .splide__arrow svg {
    fill: var(--color-text);
    width: 1rem;
    height: 1rem;
  }
  #gallery-splide .splide__arrow:hover svg {
    fill: var(--color-accent-hover);
  }

  /* Pagination dots */
  #gallery-splide .splide__pagination {
    bottom: -1.75rem;
  }
  #gallery-splide .splide__pagination__page {
    background: var(--color-border);
    opacity: 0.6;
    width: 8px;
    height: 8px;
    transition:
      background var(--transition-base),
      transform var(--transition-base),
      box-shadow var(--transition-base);
  }
  #gallery-splide .splide__pagination__page.is-active {
    background: #00e676;
    transform: scale(1.3);
    box-shadow:
      0 0 8px rgba(0, 230, 118, 0.6),
      0 0 16px rgba(0, 230, 118, 0.25);
    opacity: 1;
  }
  #gallery-splide .splide__pagination__page:hover {
    background: rgba(0, 230, 118, 0.7);
    opacity: 1;
  }

  /* Slide content */
  .gallery-slide {
    position: relative;
    border-radius: var(--radius-md);
    overflow: hidden;
    border: 1px solid var(--color-border);
    cursor: pointer;
    padding: 0;
    background: none;
    font: inherit;
    color: inherit;
    text-align: left;
    width: 100%;
    display: block;
    transition:
      border-color var(--transition-base),
      box-shadow var(--transition-base);
  }
  .gallery-slide:hover {
    border-color: rgba(0, 230, 118, 0.35);
    box-shadow:
      0 0 10px rgba(0, 230, 118, 0.2),
      0 0 20px rgba(0, 230, 118, 0.08);
  }
  .gallery-slide__img {
    width: 100%;
    aspect-ratio: 16 / 10;
    object-fit: cover;
    display: block;
    filter: brightness(0.82) saturate(0.9);
  }
  .gallery-slide__title {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 2.5rem 0.75rem 0.6rem;
    font-size: var(--text-sm);
    color: #fff;
    background: linear-gradient(transparent 0%, rgba(0, 0, 0, 0.45) 40%, rgba(0, 0, 0, 0.9) 100%);
    pointer-events: none;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
  }

  /* Spacing for pagination below */
  #gallery-splide {
    padding-bottom: var(--space-2xl);
  }
</style>
