---
import StatusPill from "./ui/StatusPill.astro";
import EventCountdown from "./EventCountdown.astro";
import { getResponsiveImageAttrs } from "../lib/images";
import { formatEventDate, type EventEntry, type EventStatus } from "../lib/events";
import { isSafeExternalUrl } from "../lib/links";

interface Props {
  event: EventEntry;
  status: EventStatus;
  showCountdown?: boolean;
  className?: string;
}

const { event, status, showCountdown = false, className } = Astro.props;

const safeUrl = isSafeExternalUrl(event.data.url) ? event.data.url : undefined;
const hasImage = Boolean(event.data.image);
const eventImage = hasImage
  ? await getResponsiveImageAttrs({
      src: event.data.image!,
      widths: [480, 768, 960],
      sizes: "(max-width: 768px) 100vw, 280px",
      width: 960,
      height: 540,
      quality: 72,
    })
  : null;
---

<li class:list={["event-item", className]}>
  {
    safeUrl ? (
      <a href={safeUrl} target="_blank" rel="noopener noreferrer" class="event-link">
        {hasImage && (
          <div class="event-link__image-wrapper">
            <img
              src={eventImage!.src}
              srcset={eventImage!.srcset}
              sizes={eventImage!.sizes}
              alt={`Photo for ${event.data.title}`}
              loading="lazy"
              decoding="async"
              width={eventImage!.width}
              height={eventImage!.height}
              class="event-link__image"
            />
          </div>
        )}
        <div class="event-link__body">
          <div class="event-link__header">
            <span class="event-link__title">{event.data.title}</span>
            <StatusPill status={status === "upcoming" ? "active" : "archived"}>
              {status === "upcoming" ? "Upcoming" : "Past"}
            </StatusPill>
          </div>
          <span class="event-link__meta">
            <time class="event-link__date" datetime={event.data.date.toISOString().split("T")[0]}>
              {formatEventDate(event.data.date, event.data.endDate)}
            </time>
            {event.data.location && <span class="event-link__location">{event.data.location}</span>}
          </span>
          <p class="event-link__summary">{event.data.summary}</p>
          {showCountdown && event.data.endDate && (
            <EventCountdown startDate={event.data.date} endDate={event.data.endDate} />
          )}
          {event.data.address && (
            <address class="event-link__address">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                <circle cx="12" cy="10" r="3" />
              </svg>
              <span>
                {event.data.location} &middot; {event.data.address}
              </span>
            </address>
          )}
        </div>
        <svg
          class="event-link__external"
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <>
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
            <polyline points="15 3 21 3 21 9" />
            <line x1="10" y1="14" x2="21" y2="3" />
          </>
        </svg>
      </a>
    ) : (
      <div class="event-link">
        {hasImage && (
          <div class="event-link__image-wrapper">
            <img
              src={eventImage!.src}
              srcset={eventImage!.srcset}
              sizes={eventImage!.sizes}
              alt={`Photo for ${event.data.title}`}
              loading="lazy"
              decoding="async"
              width={eventImage!.width}
              height={eventImage!.height}
              class="event-link__image"
            />
          </div>
        )}
        <div class="event-link__body">
          <div class="event-link__header">
            <span class="event-link__title">{event.data.title}</span>
            <StatusPill status={status === "upcoming" ? "active" : "archived"}>
              {status === "upcoming" ? "Upcoming" : "Past"}
            </StatusPill>
          </div>
          <span class="event-link__meta">
            <time class="event-link__date" datetime={event.data.date.toISOString().split("T")[0]}>
              {formatEventDate(event.data.date, event.data.endDate)}
            </time>
            {event.data.location && <span class="event-link__location">{event.data.location}</span>}
          </span>
          <p class="event-link__summary">{event.data.summary}</p>
          {showCountdown && event.data.endDate && (
            <EventCountdown startDate={event.data.date} endDate={event.data.endDate} />
          )}
          {event.data.address && (
            <address class="event-link__address">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                <circle cx="12" cy="10" r="3" />
              </svg>
              <span>
                {event.data.location} &middot; {event.data.address}
              </span>
            </address>
          )}
        </div>
      </div>
    )
  }
</li>
